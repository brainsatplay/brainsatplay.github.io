<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta property="og:title" content="Brainstorm" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://brainsatplay.com/sdk/examples/brainstorm.png" />
    <meta property="og:description" content="Brainstorm - A Multiplayer Neurotechnology Game for the Web" />
    <meta property="og:url" content="https://brainsatplay.com/sdk/examples/brainstorm" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@brainsatplay">
    <meta name="twitter:creator" content="@brainsatplay">
    <meta name="twitter:domain" content="brainsatplay.com">
    <meta name="twitter:title" content="Brainstorm">
    <meta name="twitter:url" content="https://brainsatplay.com/sdk/examples/brainstorm">
    <meta name="twitter:description" content="Brainstorm - A Multiplayer Neurotechnology Game for the Web">
    <meta name="twitter:image:src" content="https://brainsatplay.com/sdk/examples/brainstorm.png">
    <title>Brainstorm</title>
    
    <link rel=icon href=favicons/favicon.ico>
    <link rel="stylesheet" type="text/css" href="css/brainstorm.css"/>
    <script type="text/javascript" src="js/visbrain.js"></script>
    <script type="text/javascript" src="js/eegCoordinates.js"></script>
    <script type="text/javascript" src="classes/Brain.js"></script>
    <script type="text/javascript" src="classes/nBrains.js"></script>
    <script type="text/javascript" src="js/interaction.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/point-functions.js"></script>
    <script type="text/javascript" src="js/networking.js"></script>
    <script type="text/javascript" src="js/gl-matrix-min.js"></script>
    <script type="text/javascript" src="js/webgl.js"></script>
    <script type="text/javascript" src="js/shaders.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcijs@1.8.0/dist/bci.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
</head>

<body onstyle="overflow: hidden">

<div id=app>

    <div id="developer-tools" class="menu">
        <div class="icon" onclick="toggleUI()">
            <p>Toggle UI</p>
        </div>
        <!-- <div class="icon menuicon" onclick="window.open(`/downloadapp`)">
            <a><i class="fas fa-desktop fa-2x"></i></a><p>Download Desktop App</p>
        </div> -->
    </div>

    <div id="brainstorm">
        <div id="canvas-container">
            <canvas id='webgl'></canvas>
        </div>
        <div class="message-container">
            <span id="canvas-message"></span>
        </div>

        <div id="ui-elements">

        <div id='signaltypes'>
            <h4>Signal Types</h4>
            <p id="signal-type" class="small"></p>
            <button onclick="visualizations[state].signaltype = 'voltage'; document.getElementById('signal-type').innerHTML = 'voltage'; stateManager()">Voltage</button>
            <button onclick="visualizations[state].signaltype = 'synchrony'; document.getElementById('signal-type').innerHTML = 'synchrony'; stateManager()">Synchrony</button>
            <button onclick="visualizations[state].signaltype = 'delta'; document.getElementById('signal-type').innerHTML = 'delta'; stateManager()">Delta</button>
            <button onclick="visualizations[state].signaltype = 'theta'; document.getElementById('signal-type').innerHTML = 'theta'; stateManager()">Theta</button>
            <button onclick="visualizations[state].signaltype = 'alpha'; document.getElementById('signal-type').innerHTML = 'alpha'; stateManager()">Alpha</button>
            <button onclick="visualizations[state].signaltype = 'beta'; document.getElementById('signal-type').innerHTML = 'beta'; stateManager()">Beta</button>
            <button onclick="visualizations[state].signaltype = 'gamma'; document.getElementById('signal-type').innerHTML = 'gamma'; stateManager()">Gamma</button>
        </div>

        <div id="bottom-info">
            <div class="info-holder-outer">
                <h4>States</h4>
                <div class="under-header-info">
                <p id="state" class="small">&nbsp;</p>
                </div>
        <div class="info-holder-inner">
            <div class=icongrid>
            <div class="menuicon" onclick="state = 1">
                <i class="fas fa-brain fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 2">
                <i class="fas fa-wave-square fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 3">
                <i class="fas fa-users fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 4;">
                <i class="fas fa-users-cog fa-1x"></i>
            </div>
        </div>
        </div>
        </div>

        <div class="info-holder-outer">
            <h4>Connection Info</h4>

            <div id="access-mode-div" class="under-header-info">
                <p id="access-mode" class="small">Not Connected</p>
            </div>

            <div class="info-holder-inner">
                <div id="id-params" class="params" style="display:none">
            <h5>ID</h5>
            <p id="userId" class="small"></p>
          </div>

          <div id="nBrains-params" class="params" style="display:none">
            <h5>nBrains</h5>
            <p id="nBrains" class="small"></p>
        </div>
        <div id="nInterfaces-params" class="params" style="display:none">

        <h5>nInterfaces</h5>
            <p id="nInterfaces" class="small"></p>
            </div>
            <div id="connection-toggle" class="params">
                <button id="connection-button" onclick="toggleConnection();">Connect</button>
            </div>
            </div>
        </div>
        <div class="info-holder-outer">
            <h4>Effects</h4>
            <div class="under-header-info">
                <p id="effect-status" class="small">Off</p>
            </div>
        <div class="info-holder-inner">
        <div class="params">
            <button onclick="distortToggle()">Toggle Mouse Distort</button>
        </div>
    </div>
</div>
        <!-- <div class=icongrid>
            <div class="menuicon" onclick="toggleChat()">
                <i class="fas fa-comment"></i>
            </div>
            <div class="menuicon" onclick="toggleDevTools()">
                <i class="fas fa-desktop fa-1x"></i>
            </div>
        </div> -->
        </div>

        <div id="info-card">
            <h4>Brainstorm</h4>
            <p class='small'>Created by <a href="https://brainsatplay.com">Brains@Play</a></p>
            <p>A multiplayer neurotechnology game for coupling minds across geographic, social, and cultural boundaries.</p>
            <h5>Instructions</h5>
            <p>Use the <strong>States</strong> panel to view different visualizations of brain activityâ€”both individual and collective. Toggle between Signal Types on the right side of the screen.</p>
            <ol>
            <li><p>You start the experience by viewing a synthetic stream of two brains. Under <strong>Connection Info</strong>, press <strong>Enter the Brainstorm</strong> to connect with a network of real users and their brains.</p></li>
            <li><p>Copy your <strong>ID</strong> to our <a href="https://github.com/brains-at-play/brains-at-play">Python streamer</a> and send your data using OpenBCI or Neurosity headsets.</p></li>
        </ol>
        </div>

    <div id="chat">
        <ul id="messages"></ul>
        <form id="chat-form" action="">
            <label for="message"></label>
            <input type="text" id="message" autocomplete="off" placeholder="Say hello..."/>
        </form>
    </div>



    </div>
    </div>
</div>
</div>

<script>

    // Set Deployment Controls
    let option = 'server';

    // Initialize WebGL Canvas
    let canvas = document.getElementById('webgl');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let gl = canvas.getContext('webgl')

    // Set Visualization Controls
    let GENERIC_ZOOM = max([1e5/window.innerWidth,1e5/window.innerHeight])*2
    let effects = [false, 'projection','synchrony','scan'] // Order used in Shaders.js code

    let visualizations = [
        {
        name: 'Scan Phase', 
        shapes: ['sphereShells'], // shape of points
        render: gl.POINTS,
        type: 'intro',
        timer: 5.0, // display time in seconds; false has no animation
        message: ``,
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'scan',
        signaltype: undefined
    },
    {
        name: '3D Brain', 
        shapes: ['brain'],
        type: 'main',
        render: gl.POINTS,
        timer: false, 
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'projection',
        signaltype: 'voltage'
    },{
        name: 'Data Streams', 
        shapes: ['channels'],
        type: 'main',
        render: gl.LINES,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'z_displacement',
        signaltype: 'voltage'
    },{
        name: 'User Information', 
        shapes: ['brains'],
        type: 'main',
        render: gl.POINTS,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: false,
        signaltype: undefined
    },{
        name: 'Group Dynamics', 
        shapes: ['brain'],
        type: 'main',
        render: gl.POINTS,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'synchrony',
        signaltype: 'synchrony'
    }
]

    let passedEEGCoords = new Array(eegCoordinates.length);
    let eegChannelsOfInterest;

    Object.keys(eegCoordinates).forEach((name,ind) => {
        passedEEGCoords[ind] = eegCoordinates[name]
    })

    let channels = 16;
    let DESIRED_POINTS = 1e5/2; // 80000
    let SIGNAL_SUSTAIN_ORIGINAL = 100;
    let AUTO_ROTATION_X = 0.0;
    let SYNCHRONY_BUFFER_SIZE = 100;
    let DAMPING = .1;
    let epsilon = .001;

    // Declare Global Visualization Variables
    let state = 0;
    let prevState = 0;
    let animState = 0;
    let renderState = state;
    let renderLagStart;
    let animStart = Date.now();
    let brainVertices;
    let brainMesh;
    let vertexHome;
    let vertexCurr;
    let vertexVel;
    let viewMatrix;
    let projectionMatrix;

    let originalAspectX;
    let originalAspectY;

    let positionBuffer;
    let dispBuffer;
    let colorBuffer;
    let uniformLocations;
    let SIGNAL_SUSTAIN = Math.round(SIGNAL_SUSTAIN_ORIGINAL/channels);
    if (SIGNAL_SUSTAIN%2 == 0){
            SIGNAL_SUSTAIN += 1;
    }
    let pointCount;
    let color;
    let synchrony = new Array(SYNCHRONY_BUFFER_SIZE).fill(0);
    let cameraHome = visualizations[state].zoom;
    let cameraCurr = visualizations[state].zoom;
    let t = 0.0;
    let diff_x = 0;
    let diff_y = 0;
    let ease = true;
    let rotation = true;
    let zoom = true;
    let generate;
    let base_freq = 1;
    let samplerate = 125;
    let generate_interval = Math.round(samplerate*(1/base_freq))
    let count = 0;
    let messages = []
    let url;
    if (option  === 'local'){
        url = new URL('http://localhost');
    } else if (option === 'server'){
        url = new URL('https://brainsatplay.azurewebsites.net/');
    }
    let brains;
    let userId = undefined;
    let ws = undefined;
    let welcomed = false;
    let nInterfaces = undefined;

    // Set User Interactions
    let holdStatus = false;
    let mouseEv;
    let moveStatus;
    let x;
    let y;
    let prev_x;
    let prev_y;
    let scroll;
    let diff;
    let diff_total;
    let forceSink;
    let messageStartTime = undefined;

    // Set User Interactions
    let devTools = false;
    let showUI = true;
    let chat = false;
    let mouseDistort = false;
    let public = true;

    canvas.onmousedown = mouseDown;
    canvas.onmouseup = mouseUp
    canvas.onmousemove = mouseMove
    canvas.onwheel = wheelMove
    document.onkeydown = keyboardShortcuts
    bindChatSubmissionEvent()

    // Reduce Point Count
    brainVertices = reducePointCount(brainpoints, DESIRED_POINTS);
    pointCount = brainVertices.length / 3;

    // // Instantiate a Default Set of Brain
    brains = newBrains('me');
    brains.add('other');

    eegChannelsOfInterest = updateEEGChannelsOfInterest()

    generate = true;
    sendSignal(channels)

    // Begin Rendering the Visualization
    particleCloud()

</script>

</body>
</html>
